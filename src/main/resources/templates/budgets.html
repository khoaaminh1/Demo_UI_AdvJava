<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Budgets')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('budgets')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-wallet-3-fill" style="color: var(--primary);"></i>
        Budgets
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border-radius: 8px;">
          <i class="ri-user-line" style="color: var(--primary);"></i>
          <span th:if="${currentUser}" th:text="${currentUser.fullName}" style="font-weight: 600; color: var(--text-primary);">User Name</span>
        </div>
        <a class="btn secondary" th:href="@{/dashboard}">
          <i class="ri-arrow-left-line"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success" style="background: var(--success); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-checkbox-circle-line"></i>
      <span th:text="${successMessage}">Success!</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-error" style="background: var(--danger); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-error-warning-line"></i>
      <span th:text="${errorMessage}">Error!</span>
    </div>

    <div class="grid cols-3">
      <!-- Add/Edit Budget Form -->
      <div class="card" style="grid-column: span 1;">
        <div class="card-title">
          <i th:class="${editBudget != null ? 'ri-edit-line' : 'ri-add-circle-line'}"></i>
          <span th:text="${editBudget != null ? 'Edit Budget' : 'Set New Budget'}">Set New Budget</span>
        </div>
        <form class="form" th:action="@{/budgets}" method="post">
          <input type="hidden" name="id" th:if="${editBudget != null}" th:value="${editBudget.id}"/>
          
          <div class="form-group">
            <label for="categoryId">Category *</label>
            <select id="categoryId" name="categoryId" required>
              <option value="">Select a category</option>
              <option th:each="c: ${categories}" 
                      th:value="${c.id}" 
                      th:text="${c.name}"
                      th:selected="${editBudget != null && editBudget.categoryId == c.id}">Food</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="limitAmount">Budget Limit *</label>
            <input id="limitAmount" type="number" step="0.01" name="limitAmount" 
                   placeholder="e.g., 500.00" 
                   th:value="${editBudget != null ? editBudget.limitAmount : ''}"
                   required/>
          </div>
          
          <div class="grid cols-2">
            <div class="form-group">
              <label for="month">Month *</label>
              <select id="month" name="month" required>
                <option th:each="m : ${#numbers.sequence(1, 12)}" 
                        th:value="${m}" 
                        th:text="${T(java.time.Month).of(m).toString()}"
                        th:selected="${editBudget != null ? editBudget.month == m : selectedMonth == m}">
                  January
                </option>
              </select>
            </div>
            <div class="form-group">
              <label for="year">Year *</label>
              <input id="year" type="number" name="year" 
                     th:value="${editBudget != null ? editBudget.year : selectedYear}" 
                     placeholder="2025" required/>
            </div>
          </div>
          
          <div class="mt-2" style="display: flex; gap: 1rem; align-items: center;">
            <button class="btn" type="submit">
              <i th:class="${editBudget != null ? 'ri-save-line' : 'ri-add-line'}"></i>
              <span th:text="${editBudget != null ? 'Update Budget' : 'Save Budget'}">Save</span>
            </button>
            <a th:if="${editBudget != null}" 
               th:href="@{/budgets(month=${selectedMonth}, year=${selectedYear})}" 
               class="btn secondary">
              <i class="ri-close-line"></i> Cancel
            </a>
          </div>
        </form>
      </div>

      <!-- Budget Usage -->
      <div class="card" style="grid-column: span 2;">
        <div class="card-title" style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <i class="ri-funds-line"></i>
            Budget Usage for <span th:text="${ym.toString()}"></span>
          </div>
          <form method="get" action="/budgets" style="display: flex; gap: 0.5rem; align-items: center;">
            <select name="month" class="form-control" style="width: auto; padding: 0.4rem; font-size: 0.9rem;">
              <option th:each="m : ${#numbers.sequence(1, 12)}" 
                      th:value="${m}" 
                      th:text="${T(java.time.Month).of(m).toString()}"
                      th:selected="${selectedMonth == m}">
                January
              </option>
            </select>
            <input type="number" name="year" 
                   th:value="${selectedYear}" 
                   style="width: 80px; padding: 0.4rem; font-size: 0.9rem;"/>
            <button type="submit" class="btn secondary" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
              <i class="ri-search-line"></i> View
            </button>
          </form>
        </div>
        
        <div th:if="${budgetUsages != null and !budgetUsages.isEmpty()}" class="budget-usage-list">
          <div th:each="u: ${budgetUsages}" class="budget-card">
            <div class="budget-header">
              <div class="category-name" th:text="${u.categoryName}">Category</div>
              <div class="amount-details">
                <span class="spent" th:text="'$' + ${#numbers.formatDecimal(u.spent,1,'COMMA',2,'POINT')}">$0</span>
                <span class="limit">/ <span th:text="'$' + ${#numbers.formatDecimal(u.limit,1,'COMMA',2,'POINT')}">$0</span></span>
              </div>
            </div>
            <div class="progress">
              <div class="bar" 
                   th:style="'width:' + ${u.percent > 100 ? 100 : u.percent} + '%'"
                   th:classappend="${u.percent >= 90} ? 'danger' : (${u.percent >= 75} ? 'warning' : '')"></div>
            </div>
            <div class="budget-footer">
              <span class="percent-used" th:text="${u.percent} + '% used'">0% used</span>
              <span class="status-alert" 
                    th:if="${u.percent >= 90}" 
                    style="color: var(--danger);">
                <i class="ri-alert-line"></i> Limit approaching!
              </span>
            </div>
          </div>
        </div>
        
        <div th:if="${budgetUsages == null or budgetUsages.isEmpty()}" 
             class="text-center" style="padding: 2rem;">
          <i class="ri-wallet-3-line" style="font-size: 3rem; color: var(--text-muted);"></i>
          <p class="text-muted mt-1">No budget data for this month</p>
          <p class="text-muted">Set a budget for <span th:text="${ym}">this month</span> using the form.</p>
        </div>
      </div>
    </div>

  </main>
</div>
<style>
.budget-usage-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 1rem; }
.budget-card { background: var(--surface); padding: 1rem; border-radius: 8px; display: flex; flex-direction: column; gap: 0.75rem; }
.budget-header { display: flex; justify-content: space-between; align-items: baseline; }
.category-name { font-weight: 600; font-size: 1.1rem; }
.amount-details .spent { font-weight: 600; }
.amount-details .limit { font-size: 0.9rem; color: var(--text-muted); }
.progress { background: var(--bg-body); border-radius: 10px; height: 10px; overflow: hidden; }
.progress .bar { height: 100%; background: var(--primary); border-radius: 10px; transition: width 0.3s ease; }
.progress .bar.warning { background: var(--warning); }
.progress .bar.danger { background: var(--danger); }
.budget-footer { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); }
.status-alert { font-weight: 600; }
</style>
<div th:replace="fragments/scripts :: scripts"></div>
</body>
</html>
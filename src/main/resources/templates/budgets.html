<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Budgets')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('budgets')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-wallet-3-fill" style="color: var(--primary);"></i>
        Budgets
      </div>
      <div class="sub" style="font-size: 1rem; color: var(--text-secondary);">
        <i class="ri-calendar-line"></i> 
        Viewing: <span class="fw-semibold" th:text="${ym}">2024-10</span>
      </div>
    </div>

    <!-- Set Budget Form -->
    <div class="card">
      <div class="card-title">
        <i th:class="${editBudget != null ? 'ri-edit-line' : 'ri-add-circle-line'}"></i>
        <span th:text="${editBudget != null ? 'Edit Budget' : 'Set Budget'}">Set Budget</span>
      </div>
      <form class="form" 
            th:action="${editBudget != null ? '/budgets/' + editBudget.id + '/update' : '/budgets'}" 
            method="post">
        <div class="grid cols-4">
          <div class="form-group">
            <label for="categoryId">Category *</label>
            <select id="categoryId" name="categoryId" required>
              <option value="">Select a category</option>
              <option th:each="c: ${categories}" 
                      th:value="${c.id}" 
                      th:text="${c.name}"
                      th:selected="${editBudget != null && editBudget.category.id == c.id}">Food</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="limit">Budget Limit *</label>
            <input id="limit" type="number" step="0.01" name="limit" 
                   placeholder="e.g., 500.00" 
                   th:value="${editBudget != null ? editBudget.limitAmount : ''}"
                   required/>
          </div>
          
          <div class="form-group">
            <label for="month">Month *</label>
            <select id="month" name="month" required>
              <option th:each="m : ${#numbers.sequence(1, 12)}" 
                      th:value="${m}" 
                      th:text="${T(java.time.Month).of(m).toString()}"
                      th:selected="${editBudget != null ? editBudget.month == m : selectedMonth == m}">
                January
              </option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="year">Year *</label>
            <input id="year" type="number" name="year" 
                   th:value="${editBudget != null ? editBudget.year : selectedYear}" 
                   placeholder="2025" required/>
          </div>
        </div>
        
        <div class="mt-2" style="display: flex; gap: 1rem; align-items: center;">
          <button class="btn" type="submit">
            <i th:class="${editBudget != null ? 'ri-save-line' : 'ri-add-line'}"></i>
            <span th:text="${editBudget != null ? 'Update Budget' : 'Save Budget'}">Save Budget</span>
          </button>
          
          <div th:if="${editBudget == null}" style="display: flex; align-items: center; gap: 0.5rem;">
            <input type="checkbox" id="applyToAllMonths" name="applyToAllMonths" value="true" style="width: auto;"/>
            <label for="applyToAllMonths" style="margin: 0; font-size: 0.9rem; color: var(--text-secondary);">
              Apply to all 12 months
            </label>
          </div>
          
          <a th:if="${editBudget != null}" 
             th:href="@{/budgets(month=${selectedMonth}, year=${selectedYear})}" 
             class="btn secondary">
            <i class="ri-close-line"></i> Cancel
          </a>
        </div>
      </form>
    </div>

    <div class="grid cols-2 mt-3">
      <!-- Budget Usages with Month Filter -->
      <div class="card">
        <div class="card-title" style="display: flex; align-items: center; justify-content: space-between;">
          <div>
            <i class="ri-funds-line"></i>
            Budget Usage
          </div>
          <form method="get" action="/budgets" style="display: flex; gap: 0.5rem; align-items: center;">
            <select name="month" class="form-control" style="width: auto; padding: 0.4rem; font-size: 0.9rem;">
              <option th:each="m : ${#numbers.sequence(1, 12)}" 
                      th:value="${m}" 
                      th:text="${T(java.time.Month).of(m).toString()}"
                      th:selected="${selectedMonth == m}">
                January
              </option>
            </select>
            <input type="number" name="year" 
                   th:value="${selectedYear}" 
                   style="width: 80px; padding: 0.4rem; font-size: 0.9rem;"/>
            <button type="submit" class="btn secondary" style="padding: 0.4rem 0.8rem; font-size: 0.9rem;">
              <i class="ri-search-line"></i> View
            </button>
          </form>
        </div>
        
        <div th:if="${usages != null and !usages.isEmpty()}">
          <div th:each="u: ${usages}" style="margin-bottom:20px">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px">
              <div class="fw-semibold" th:text="${u.categoryName}">Category</div>
              <div class="sub">
                <span class="fw-semibold" th:text="'$' + ${#numbers.formatDecimal(u.spent,1,'COMMA',2,'POINT')}">$0</span>
                / 
                <span th:text="'$' + ${#numbers.formatDecimal(u.limit,1,'COMMA',2,'POINT')}">$0</span>
              </div>
            </div>
            <div class="progress">
              <div class="bar" 
                   th:style="'width:' + ${u.percent > 100 ? 100 : u.percent} + '%'"
                   th:classappend="${u.percent >= 90} ? 'danger' : (${u.percent >= 75} ? 'warning' : '')"></div>
            </div>
            <div style="display:flex; justify-content:space-between; margin-top:4px">
              <span class="sub" th:text="${u.percent} + '% used'">0% used</span>
              <span class="sub" 
                    th:if="${u.percent >= 90}" 
                    style="color: var(--danger); font-weight: 600;">
                <i class="ri-alert-line"></i> Limit approaching!
              </span>
              <span class="sub" 
                    th:if="${u.percent >= 75 and u.percent < 90}" 
                    style="color: var(--warning); font-weight: 600;">
                <i class="ri-error-warning-line"></i> Monitor spending
              </span>
            </div>
          </div>
        </div>
        
        <div th:if="${usages == null or usages.isEmpty()}" 
             class="text-center" style="padding: 2rem;">
          <i class="ri-wallet-3-line" style="font-size: 3rem; color: var(--text-muted);"></i>
          <p class="text-muted mt-1">No budget data for this month</p>
          <p class="text-muted">Set a budget for <span th:text="${ym}">this month</span></p>
        </div>
      </div>

      <!-- Quick Stats -->
      <div class="card">
        <div class="card-title">
          <i class="ri-bar-chart-box-line"></i>
          Quick Stats
        </div>
        <div class="stats-row">
          <span class="stats-label">Total Budgets Set:</span>
          <span class="stats-value" th:text="${budgets != null ? budgets.size() : 0}">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Categories Tracked:</span>
          <span class="stats-value" th:text="${categories != null ? categories.size() : 0}">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">This Month Budgets:</span>
          <span class="stats-value" th:text="${usages != null ? usages.size() : 0}">0</span>
        </div>
        <div class="mt-3" style="padding: 1rem; background: var(--bg-body); border-radius: 8px;">
          <div class="text-muted" style="font-size: 0.85rem; margin-bottom: 0.5rem;">
            <i class="ri-lightbulb-line"></i> Pro Tip
          </div>
          <p style="font-size: 0.9rem; margin: 0; color: var(--text-secondary);">
            Use "Apply to all 12 months" when setting annual budgets for consistent categories like Rent or Netflix.
          </p>
        </div>
      </div>
    </div>

    <!-- All Budgets Table with Actions -->
    <div class="card mt-3">
      <div class="card-title">
        <i class="ri-list-check"></i>
        All Budgets
        <span class="badge" style="margin-left: auto;" th:if="${budgets != null}" 
              th:text="${budgets.size()} + ' total'">0 total</span>
      </div>
      
      <div th:if="${budgets != null and !budgets.isEmpty()}" 
           style="max-height: 400px; overflow-y: auto;">
        <table class="table">
          <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
            <tr>
              <th>Category</th>
              <th>Month</th>
              <th>Year</th>
              <th class="right">Limit Amount</th>
              <th class="center" style="width: 120px;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="b: ${budgets}">
              <td>
                <span class="badge">
                  <i class="ri-price-tag-3-line"></i>
                  <span th:text="${b.category.name}">Food</span>
                </span>
              </td>
              <td th:text="${T(java.time.Month).of(b.month).toString()}">October</td>
              <td th:text="${b.year}">2025</td>
              <td class="amount fw-semibold" th:text="'$' + ${#numbers.formatDecimal(b.limitAmount,1,'COMMA',2,'POINT')}">$0.00</td>
              <td class="center">
                <div style="display: flex; gap: 0.5rem; justify-content: center;">
                  <a th:href="@{/budgets(editId=${b.id}, month=${selectedMonth}, year=${selectedYear})}" 
                     class="btn secondary" 
                     style="padding: 0.5rem; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;"
                     title="Edit">
                    <i class="ri-pencil-line"></i>
                  </a>
                  <form th:action="@{/budgets/{id}/delete(id=${b.id})}" method="post" style="margin: 0;">
                    <input type="hidden" name="month" th:value="${selectedMonth}"/>
                    <input type="hidden" name="year" th:value="${selectedYear}"/>
                    <button type="submit" 
                            class="btn danger" 
                            style="padding: 0.5rem; width: 36px; height: 36px; display: inline-flex; align-items: center; justify-content: center;"
                            title="Delete"
                            onclick="return confirm('Are you sure you want to delete this budget?')">
                      <i class="ri-delete-bin-line"></i>
                    </button>
                  </form>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div th:if="${budgets == null or budgets.isEmpty()}" 
           class="text-center" style="padding: 3rem;">
        <i class="ri-wallet-3-line" style="font-size: 4rem; color: var(--text-muted);"></i>
        <p class="text-muted mt-1">No budgets set yet</p>
        <p class="text-muted">Start by setting your first budget above</p>
      </div>
      
      <div class="footer-note mt-2">
        <i class="ri-lightbulb-line"></i>
        Tip: Set realistic budgets for each category to help control your spending and achieve your financial goals.
      </div>
    </div>

  </main>
</div>
<div th:replace="fragments/scripts :: scripts"></div>
</body>
</html>

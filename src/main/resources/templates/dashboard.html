<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Dashboard')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('dashboard')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-dashboard-2-fill" style="color: var(--primary);"></i>
        Dashboard
      </div>
      <input class="search" placeholder="Search transactions, categories..."/>
    </div>

    <!-- KPI Cards -->
    <div class="grid cols-3">
      <div class="card">
        <div class="card-title">
          <i class="ri-arrow-down-circle-line" style="color: var(--success);"></i>
          Total Income
        </div>
        <div class="kpi positive" th:text="'$' + ${#numbers.formatDecimal(vm.mtdIncome,1,'COMMA',2,'POINT')}">$0.00</div>
        <div class="sub">Month to date</div>
      </div>
      <div class="card">
        <div class="card-title">
          <i class="ri-arrow-up-circle-line" style="color: var(--danger);"></i>
          Total Expense
        </div>
        <div class="kpi negative" th:text="'$' + ${#numbers.formatDecimal(vm.mtdExpense,1,'COMMA',2,'POINT')}">$0.00</div>
        <div class="sub">Month to date</div>
      </div>
      <div class="card">
        <div class="card-title">
          <i class="ri-wallet-3-line" style="color: var(--info);"></i>
          Net Balance
        </div>
        <div class="kpi" th:text="'$' + ${#numbers.formatDecimal(vm.net,1,'COMMA',2,'POINT')}" 
             th:classappend="${vm.net >= 0} ? 'positive' : 'negative'">$0.00</div>
        <div class="sub">Income - Expense</div>
      </div>
    </div>

    <!-- Charts Section -->
    <div class="grid cols-2 mt-3">
      <div class="card">
        <div class="card-title">
          <i class="ri-pie-chart-2-line"></i>
          Spending by Category
        </div>
        <div style="position: relative; height: 300px;">
          <canvas id="catChart"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-title">
          <i class="ri-line-chart-line"></i>
          Cash Flow Trend (Last 6 Months)
        </div>
        <div style="position: relative; height: 300px;">
          <canvas id="flowChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Data Tables Section -->
    <div class="grid cols-2 mt-3">
      <div class="card">
        <div class="card-title">
          <i class="ri-time-line"></i>
          Recent Transactions
        </div>
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Merchant</th>
              <th>Category</th>
              <th>Account</th>
              <th class="right">Amount</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="t : ${vm.recentTransactions}">
              <td th:text="${t.date}">2024-10-01</td>
              <td th:text="${t.merchant}">Merchant</td>
              <td>
                <span class="badge">
                  <i class="ri-price-tag-3-line"></i>
                  <span th:text="${t.category != null ? t.category.name : 'Uncategorized'}">Food</span>
                </span>
              </td>
              <td th:text="${t.account.name}">Account</td>
              <td class="amount" 
                  th:classappend="${t.category.type.name()=='EXPENSE'} ? 'expense' : 'income'"
                  th:text="'$' + ${#numbers.formatDecimal(t.amount,1,'COMMA',2,'POINT')}">$0.00</td>
            </tr>
          </tbody>
        </table>
        <div class="text-center mt-2">
          <a th:href="@{/transactions}" class="btn secondary">
            <i class="ri-list-check"></i> View All Transactions
          </a>
        </div>
      </div>
      
      <div class="card">
        <div class="card-title">
          <i class="ri-funds-line"></i>
          Budget Overview (This Month)
        </div>
        <div th:if="${vm.budgetUsages != null and !vm.budgetUsages.isEmpty()}">
          <div th:each="u: ${vm.budgetUsages}" style="margin-bottom:16px">
            <div style="display:flex; justify-content:space-between; margin-bottom:8px">
              <div class="fw-semibold" th:text="${u.categoryName}">Category</div>
              <div class="sub" th:text="'$' + ${#numbers.formatDecimal(u.spent,1,'COMMA',2,'POINT')} + ' / $' + ${#numbers.formatDecimal(u.limit,1,'COMMA',2,'POINT')}">
                $0 / $0
              </div>
            </div>
            <div class="progress">
              <div class="bar" 
                   th:style="'width:' + ${u.percent > 100 ? 100 : u.percent} + '%'"
                   th:classappend="${u.percent >= 90} ? 'danger' : (${u.percent >= 75} ? 'warning' : '')"></div>
            </div>
            <div class="sub mt-1" th:if="${u.percent >= 90}" style="color: var(--danger);">
              <i class="ri-alert-line"></i> Budget limit approaching!
            </div>
          </div>
        </div>
        <div th:if="${vm.budgetUsages == null or vm.budgetUsages.isEmpty()}" 
             class="text-center" style="padding: 2rem;">
          <i class="ri-wallet-3-line" style="font-size: 3rem; color: var(--text-muted);"></i>
          <p class="text-muted mt-1">No budgets set yet</p>
        </div>
        <div class="footer-note">
          <i class="ri-lightbulb-line"></i>
          Tip: Set budgets per category in the <a th:href="@{/budgets}" style="color: var(--primary); text-decoration: none; font-weight: 600;">Budgets page</a>.
        </div>
      </div>
    </div>

  </main>
</div>

<script th:inline="javascript">
  // Wait for DOM to be fully loaded
  document.addEventListener('DOMContentLoaded', function() {
    // Get data from Thymeleaf
    const catLabels = /*[[${vm.categoryLabels}]]*/ [];
    const catValues = /*[[${vm.categoryValues}]]*/ [];
    const months = /*[[${vm.months}]]*/ [];
    const incomes = /*[[${vm.incomes}]]*/ [];
    const expenses = /*[[${vm.expenses}]]*/ [];
    
    // Debug: log data to console
    console.log('=== Dashboard Chart Data ===');
    console.log('Category Labels:', catLabels);
    console.log('Category Values:', catValues);
    console.log('Months:', months);
    console.log('Incomes:', incomes);
    console.log('Expenses:', expenses);
    
    // Convert BigDecimal to numbers if needed
    const catValuesNum = catValues.map(v => {
      if (typeof v === 'object' && v !== null) {
        return parseFloat(v.toString());
      }
      return parseFloat(v);
    });
    
    const incomesNum = incomes.map(v => {
      if (typeof v === 'object' && v !== null) {
        return parseFloat(v.toString());
      }
      return parseFloat(v);
    });
    
    const expensesNum = expenses.map(v => {
      if (typeof v === 'object' && v !== null) {
        return parseFloat(v.toString());
      }
      return parseFloat(v);
    });
    
    console.log('Converted Values:', catValuesNum);
    console.log('Converted Incomes:', incomesNum);
    console.log('Converted Expenses:', expensesNum);
    
    // Render charts
    if (catLabels && catLabels.length > 0 && catValuesNum && catValuesNum.length > 0) {
      console.log('Rendering doughnut chart...');
      renderDoughnut('catChart', catLabels, catValuesNum);
    } else {
      console.warn('No category data available for doughnut chart');
    }
    
    if (months && months.length > 0 && incomesNum && incomesNum.length > 0) {
      console.log('Rendering line chart...');
      renderLine('flowChart', months, incomesNum, expensesNum);
    } else {
      console.warn('No cash flow data available for line chart');
    }
    
    console.log('=== Chart rendering complete ===');
  });
</script>
<div th:replace="fragments/scripts :: scripts"></div>
</body>
</html>

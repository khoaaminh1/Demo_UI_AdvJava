<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Transactions')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('transactions')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-exchange-dollar-fill" style="color: var(--primary);"></i>
        Transactions
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border-radius: 8px;">
          <i class="ri-user-line" style="color: var(--primary);"></i>
          <span th:if="${currentUser}" th:text="${currentUser.fullName}" style="font-weight: 600; color: var(--text-primary);">User Name</span>
          <span th:unless="${currentUser}" style="font-weight: 600; color: var(--text-primary);">Guest</span>
        </div>
        <a class="btn secondary" th:href="@{/dashboard}">
          <i class="ri-arrow-left-line"></i> Back to Dashboard
        </a>
      </div>
    </div>
    
    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success" style="background: var(--success); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-checkbox-circle-line"></i>
      <span th:text="${successMessage}">Success!</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-error" style="background: var(--danger); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-error-warning-line"></i>
      <span th:text="${errorMessage}">Error!</span>
    </div>

    <!-- Add New Transaction Form -->
    <div class="card">
      <div class="card-title">
        <i class="ri-add-circle-line"></i>
        Add New Transaction
      </div>
      <form class="form" th:action="@{/transactions}" method="post">
        <div class="grid cols-3">
          <div class="form-group">
            <label for="date">Date *</label>
            <input type="date" id="date" name="date" required/>
          </div>
          
          <div class="form-group">
            <label for="merchant">Merchant / Description *</label>
            <input type="text" id="merchant" name="merchant" placeholder="e.g., Starbucks, Salary" required/>
          </div>
          
          <div class="form-group">
            <label for="amount">Amount *</label>
            <input type="number" id="amount" step="0.01" name="amount" placeholder="0.00" required/>
          </div>
        </div>
        
        <div class="grid cols-3">
          <div class="form-group">
            <label for="categoryId">Category *</label>
            <select id="categoryId" name="categoryId" required>
              <option value="">Select a category</option>
              <option th:each="c: ${categories}" th:value="${c.id}" th:text="${c.name}">Food</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="accountId">Account *</label>
            <select id="accountId" name="accountId" required>
              <option value="">Select an account</option>
              <option th:each="a: ${accounts}" th:value="${a.id}" th:text="${a.name}">Wallet</option>
            </select>
          </div>
          
          <div class="form-group">
            <label for="note">Note (Optional)</label>
            <input type="text" id="note" name="note" placeholder="Additional notes"/>
          </div>
        </div>
        
        <div class="mt-2">
          <button class="btn" type="submit">
            <i class="ri-save-line"></i> Add Transaction
          </button>
        </div>
      </form>
    </div>

    <!-- Transactions List with scrollable table -->
    <div class="card mt-3">
      <div class="card-title">
        <i class="ri-list-check"></i>
        All Transactions
        <span class="badge" style="margin-left: auto;" th:if="${transactions != null}" 
              th:text="${transactions.size()} + ' transactions'">0 transactions</span>
      </div>
      
      <div th:if="${transactions != null and !transactions.isEmpty()}" 
           style="max-height: 500px; overflow-y: auto; overflow-x: auto;">
        <table class="table">
          <thead style="position: sticky; top: 0; background: var(--bg-card); z-index: 10;">
            <tr>
              <th>Date</th>
              <th>Merchant</th>
              <th>Category</th>
              <th>Account</th>
              <th class="right">Amount</th>
              <th style="width: 100px; text-align: center;">Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="t: ${transactions}">
              <td th:text="${t.date}">2024-10-01</td>
              <td>
                <div th:text="${t.merchant}" style="font-weight: 600;">Merchant</div>
                <div th:if="${t.note}" th:text="${t.note}" style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;">Note</div>
              </td>
              <td>
                <span class="badge">
                  <i class="ri-price-tag-3-line"></i>
                  <span th:text="${t.category != null ? t.category.name : 'Uncategorized'}">Food</span>
                </span>
              </td>
              <td th:text="${t.account != null ? t.account.name : 'N/A'}">Wallet</td>
              <td class="amount" 
                  th:classappend="${t.category != null and t.category.type.name()=='EXPENSE'} ? 'expense' : 'income'"
                  th:text="'$' + ${#numbers.formatDecimal(t.amount,1,'COMMA',2,'POINT')}">$0.00</td>
              <td style="text-align: center;">
                <form th:action="@{/transactions/{id}/delete(id=${t.id})}" method="post" style="display: inline;" 
                      onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                  <button type="submit" class="btn-icon" style="background: var(--danger); color: white; border: none; padding: 0.5rem; border-radius: 6px; cursor: pointer;">
                    <i class="ri-delete-bin-line"></i>
                  </button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div th:if="${transactions == null or transactions.isEmpty()}" 
           class="text-center" style="padding: 3rem;">
        <i class="ri-exchange-dollar-line" style="font-size: 4rem; color: var(--text-muted);"></i>
        <p class="text-muted mt-1">No transactions yet</p>
        <p class="text-muted">Add your first transaction using the form</p>
      </div>
    </div>

    <!-- Summary Cards -->
    <div class="grid cols-3 mt-3">
      <div class="card">
        <div class="card-title">
          <i class="ri-bar-chart-box-line"></i>
          Quick Stats
        </div>
        <div class="stats-row">
          <span class="stats-label">Total Transactions:</span>
          <span class="stats-value" th:text="${transactions != null ? transactions.size() : 0}">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Categories Used:</span>
          <span class="stats-value" th:text="${categories != null ? categories.size() : 0}">0</span>
        </div>
        <div class="stats-row">
          <span class="stats-label">Accounts:</span>
          <span class="stats-value" th:text="${accounts != null ? accounts.size() : 0}">0</span>
        </div>
      </div>
    </div>

  </main>
</div>
<div th:replace="fragments/scripts :: scripts"></div>
</body>
</html>
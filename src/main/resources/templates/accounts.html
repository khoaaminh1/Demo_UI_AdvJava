<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Accounts')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('accounts')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-bank-card-fill" style="color: var(--primary);"></i>
        Accounts
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border-radius: 8px;">
          <i class="ri-user-line" style="color: var(--primary);"></i>
          <span th:if="${currentUser}" th:text="${currentUser.fullName}" style="font-weight: 600; color: var(--text-primary);">User Name</span>
        </div>
        <a class="btn secondary" th:href="@{/dashboard}">
          <i class="ri-arrow-left-line"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Success/Error Messages -->
    <div th:if="${successMessage}" class="alert alert-success" style="background: var(--success); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-checkbox-circle-line"></i>
      <span th:text="${successMessage}">Success!</span>
    </div>
    <div th:if="${errorMessage}" class="alert alert-error" style="background: var(--danger); color: white; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
      <i class="ri-error-warning-line"></i>
      <span th:text="${errorMessage}">Error!</span>
    </div>

    <div class="grid cols-3">
      <!-- Add/Edit Account Form -->
      <div class="card" style="grid-column: span 1;">
        <div class="card-title">
          <i th:class="${editAccount != null ? 'ri-edit-line' : 'ri-add-circle-line'}"></i>
          <span th:text="${editAccount != null ? 'Edit Account' : 'Add New Account'}">Add New Account</span>
        </div>
        <form class="form" th:action="@{/accounts}" method="post">
          <input type="hidden" name="id" th:if="${editAccount != null}" th:value="${editAccount.id}"/>
          
          <div class="form-group">
            <label for="accountName">Account Name *</label>
            <input id="accountName" name="name" placeholder="e.g., My Checking Account" th:value="${editAccount != null ? editAccount.name : ''}" required/>
          </div>

          <div class="form-group">
            <label for="accountType">Account Type *</label>
            <select id="accountType" name="type" required>
                <option th:each="type : ${T(com.example.pftui.model.AccountType).values()}" 
                        th:value="${type}" 
                        th:text="${type.name().replace('_', ' ')}" 
                        th:selected="${editAccount != null and editAccount.type == type}">CASH</option>
            </select>
          </div>

          <div class="grid cols-2">
            <div class="form-group">
                <label for="initialBalance">Initial Balance *</label>
                <input id="initialBalance" type="number" step="0.01" name="initialBalance" placeholder="0.00" th:value="${editAccount != null ? editAccount.initialBalance : '0.00'}" required/>
            </div>
            <div class="form-group">
                <label for="currency">Currency</label>
                <input id="currency" name="currency" th:value="${editAccount != null ? editAccount.currency : 'USD'}" required/>
            </div>
          </div>

          <div class="form-group" th:if="${editAccount != null}">
            <label for="status">Status</label>
            <select id="status" name="status">
                <option th:each="s : ${T(com.example.pftui.model.AccountStatus).values()}" 
                        th:value="${s}" 
                        th:text="${s.name()}" 
                        th:selected="${editAccount.status == s}">ACTIVE</option>
            </select>
          </div>
          
          <div class="mt-2" style="display: flex; gap: 1rem; align-items: center;">
            <button class="btn" type="submit">
              <i th:class="${editAccount != null ? 'ri-save-line' : 'ri-add-line'}"></i>
              <span th:text="${editAccount != null ? 'Update Account' : 'Add Account'}">Save</span>
            </button>
            <a th:if="${editAccount != null}" th:href="@{/accounts}" class="btn secondary">
              <i class="ri-close-line"></i> Cancel
            </a>
          </div>
        </form>
      </div>

      <!-- Accounts List -->
      <div style="grid-column: span 2; display: flex; flex-direction: column; gap: 1rem;">
        <div class="card">
            <div class="card-title">Total Balance (Active Accounts)</div>
            <div class="kpi" th:classappend="${totalBalance >= 0 ? 'positive' : 'negative'}" th:text="'$' + ${#numbers.formatDecimal(totalBalance, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
        </div>
        <div class="account-list">
            <div th:each="acc : ${accounts}" class="account-card" th:classappend="${acc.status.name() == 'INACTIVE'} ? 'inactive' : ''">
                <div class="account-header">
                    <div class="account-icon"><i class="ri-bank-card-2-line"></i></div>
                    <div class="account-name" th:text="${acc.name}">Account Name</div>
                    <div class="account-status" th:text="${acc.status.name()}">ACTIVE</div>
                </div>
                <div class="account-balance" th:classappend="${acc.currentBalance >= 0 ? 'positive' : 'negative'}" th:text="'$' + ${#numbers.formatDecimal(acc.currentBalance, 1, 'COMMA', 2, 'POINT')}">$0.00</div>
                <div class="account-type" th:text="${acc.type.name().replace('_', ' ')}">CHECKING</div>
                <div class="account-actions">
                    <a th:href="@{/accounts(editId=${acc.id})}" class="btn-icon" title="Edit"><i class="ri-pencil-line"></i></a>
                    <form th:action="@{/accounts/{id}/toggle-status(id=${acc.id})}" method="post" style="display: inline;">
                        <button type="submit" class="btn-icon" th:title="${acc.status.name() == 'ACTIVE' ? 'Deactivate' : 'Activate'}">
                            <i th:class="${acc.status.name() == 'ACTIVE' ? 'ri-eye-off-line' : 'ri-eye-line'}"></i>
                        </button>
                    </form>
                    <form th:action="@{/accounts/{id}/delete(id=${acc.id})}" method="post" onsubmit="return confirm('Are you sure? Deleting an account will also delete all its transactions.');">
                        <button type="submit" class="btn-icon danger" title="Delete"><i class="ri-delete-bin-line"></i></button>
                    </form>
                </div>
            </div>
        </div>
      </div>
    </div>

  </main>
</div>
<style>
.account-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem; }
.account-card { background: var(--surface); padding: 1.5rem; border-radius: 8px; display: flex; flex-direction: column; gap: 1rem; border-left: 4px solid var(--primary); }
.account-card.inactive { border-left-color: var(--text-muted); opacity: 0.6; }
.account-header { display: flex; align-items: center; gap: 1rem; }
.account-icon { font-size: 2rem; color: var(--primary); }
.account-name { font-weight: 600; font-size: 1.2rem; flex-grow: 1; }
.account-status { font-size: 0.8rem; font-weight: 600; padding: 0.2rem 0.5rem; border-radius: 6px; background: var(--success-light); color: var(--success); }
.account-card.inactive .account-status { background: var(--surface-dark); color: var(--text-muted); }
.account-balance { font-size: 2rem; font-weight: 700; }
.account-type { font-size: 0.9rem; color: var(--text-secondary); text-transform: capitalize; }
.account-actions { display: flex; gap: 0.5rem; margin-top: 1rem; border-top: 1px solid var(--bg-body); padding-top: 1rem; }
.account-actions .btn-icon { background: transparent; border: none; color: var(--text-secondary); cursor: pointer; padding: 0.5rem; font-size: 1.2rem; }
.account-actions .btn-icon.danger { color: var(--danger); }
</style>
<div th:replace="fragments/scripts :: scripts"></div>
</body>
</html>
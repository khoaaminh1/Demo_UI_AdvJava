<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/head :: head('Settings')"></head>
<body>
<div class="app">
  <aside th:replace="fragments/sidebar :: sidebar('settings')"></aside>
  <main class="content">
    <div class="topbar">
      <div class="title">
        <i class="ri-settings-3-fill" style="color: var(--primary);"></i>
        Settings
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; background: var(--surface); border-radius: 8px;">
          <i class="ri-user-line" style="color: var(--primary);"></i>
          <span th:if="${currentUser}" th:text="${currentUser.fullName}" style="font-weight: 600; color: var(--text-primary);">User Name</span>
        </div>
        <a class="btn secondary" th:href="@{/dashboard}">
          <i class="ri-arrow-left-line"></i> Back to Dashboard
        </a>
      </div>
    </div>

    <!-- This is where the server-side messages will be rendered, but they will be hidden -->
    <div id="successMessage" th:if="${successMessage}" th:text="${successMessage}" style="display: none;"></div>
    <div id="errorMessage" th:if="${errorMessage}" th:text="${errorMessage}" style="display: none;"></div>

    <div class="grid cols-2">
      <!-- Change Password -->
      <div class="card">
        <div class="card-title">
          <i class="ri-lock-password-line"></i>
          Change Password
        </div>
        <form class="form" th:action="@{/settings/change-password}" method="post">
          <div class="form-group">
            <label for="currentPassword">Current Password</label>
            <input type="password" id="currentPassword" name="currentPassword" required/>
          </div>
          <div class="form-group">
            <label for="newPassword">New Password</label>
            <input type="password" id="newPassword" name="newPassword" required/>
          </div>
          <div class="form-group">
            <label for="confirmPassword">Confirm New Password</label>
            <input type="password" id="confirmPassword" name="confirmPassword" required/>
          </div>
          <div class="mt-2">
            <button class="btn" type="submit">
              <i class="ri-save-line"></i> Update Password
            </button>
          </div>
        </form>
      </div>

      <!-- Two-Factor Authentication -->
      <div class="card">
        <div class="card-title">
          <i class="ri-shield-keyhole-line"></i>
          Two-Factor Authentication (2FA)
        </div>
        <!-- 2FA Enabled State -->
        <div th:if="${currentUser.twoFactorEnabled}">
          <div class="two-fa-status">
            <div class="status-icon enabled">
              <i class="ri-checkbox-circle-fill"></i>
            </div>
            <div class="status-text">
              <h4>2FA is Currently Enabled</h4>
              <p class="sub">Your account is protected with an additional layer of security.</p>
            </div>
          </div>
          <div class="mt-3">
            <p class="sub">When you log in, you will be required to enter a code sent to your email address.</p>
          </div>
          <div class="mt-3" style="border-top: 1px solid var(--bg-body); padding-top: 1.5rem;">
            <form th:action="@{/settings/2fa/disable}" method="post">
              <button class="btn danger" type="submit">
                <i class="ri-forbid-2-line"></i> Disable 2FA
              </button>
            </form>
          </div>
        </div>

        <!-- 2FA Disabled State -->
        <div th:unless="${currentUser.twoFactorEnabled}">
          <div class="two-fa-status">
            <div class="status-icon disabled">
              <i class="ri-close-circle-fill"></i>
            </div>
            <div class="status-text">
              <h4>2FA is Currently Disabled</h4>
              <p class="sub">Enable 2FA to add an extra layer of security to your account.</p>
            </div>
          </div>
          <div class="mt-3">
            <p class="sub">Two-factor authentication adds an extra layer of security to your account by requiring more than just a password to log in. You'll need to provide a code sent to your email address.</p>
          </div>
          <div class="mt-3" style="border-top: 1px solid var(--bg-body); padding-top: 1.5rem;">
            <form th:action="@{/settings/2fa/enable}" method="post">
              <button class="btn success" type="submit">
                <i class="ri-shield-check-line"></i> Enable 2FA
              </button>
            </form>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>
<style>
.two-fa-status { display: flex; align-items: center; gap: 1.5rem; background: var(--surface-dark); padding: 1.5rem; border-radius: 8px; }
.status-icon { font-size: 2.5rem; }
.status-icon.enabled { color: var(--success); }
.status-icon.disabled { color: var(--danger); }
.status-text h4 { margin: 0 0 0.25rem 0; font-size: 1.2rem; }
.status-text p { margin: 0; }

/* Toast Notification Styles */
#toast-container { position: fixed; top: 20px; right: 20px; z-index: 1050; display: flex; flex-direction: column; gap: 10px; }
.toast { display: flex; align-items: center; padding: 15px 20px; border-radius: 8px; color: #fff; font-family: 'Inter', sans-serif; min-width: 300px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); transform: translateX(110%); opacity: 0; transition: transform 0.5s ease, opacity 0.5s ease; }
.toast.show { transform: translateX(0); opacity: 1; }
.toast.success { background-color: #10b981; }
.toast.error { background-color: #ef4444; }
.toast-icon { font-size: 1.5rem; margin-right: 15px; }
.toast-message { flex-grow: 1; font-weight: 500; }
.toast-close { cursor: pointer; font-size: 1.2rem; opacity: 0.8; }
.toast-close:hover { opacity: 1; }
</style>
<div id="toast-container"></div>

<div th:replace="fragments/scripts :: scripts"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');

    if (successMessage && successMessage.textContent) {
        showToast(successMessage.textContent, 'success');
    }

    if (errorMessage && errorMessage.textContent) {
        showToast(errorMessage.textContent, 'error');
    }
});

function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const iconClass = type === 'success' ? 'ri-checkbox-circle-fill' : 'ri-close-circle-fill';
    
    toast.innerHTML = `
        <div class="toast-icon"><i class="${iconClass}"></i></div>
        <div class="toast-message">${message}</div>
        <div class="toast-close" onclick="this.parentElement.remove()"><i class="ri-close-line"></i></div>
    `;
    
    container.appendChild(toast);
    
    setTimeout(() => {
        toast.classList.add('show');
    }, 100); // Delay for CSS transition

    setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => {
            toast.remove();
        }, 500); // Wait for fade out transition
    }, 5000); // Toast disappears after 5 seconds
}
</script>

</body>
</html>